# sd-hiresfix-batch-upscaler

[日本語](https://note.com/noah_arte/n/n6c784bf2a68a)

A Python script to batch upscale multiple images at once using Stable Diffusion WebUI(Automatic1111)'s **Hires.fix** feature.
It reads each image's metadata (PNG Info) and regenerates it under the same conditions with Hires.fix enabled.


## Features

- Because it uses the WebUI API of Stable Diffusion for Hires.fix, it produces the same results as manually upscaling from the WebUI.
- The images must still contain the generation parameters from Stable Diffusion (so this won’t work for images created by other services like Novel AI).


## Environment

- Python 3.9+
- Stable Diffusion WebUI AUTOMATIC1111 (v1.10.1)


## Cautions

Tested in a local Windows 11 environment using Stable Diffusion WebUI AUTOMATIC1111 (v1.10.1).
It will likely work on Mac/Linux and on forge/reForge as well, but this has not been verified.


## Installation & Initial Setup

### 1. Clone this repository

In your command prompt, run:

```bash
git clone https://github.com/nelke-jp/sd-hiresfix-batch-upscaler.git
```

### 2. Configure the script

A folder named `sd-hiresfix-batch-upscaler` will be created. Open the file `hires_batch_upscaler.py` inside that folder in a text editor.

### 3. Set directory paths

Edit the following lines in `hires_batch_upscaler.py` to match your environment:

**Settings:**

* `INPUT_DIR` : Directory for images you want to upscale
* `OUTPUT_DIR` : Directory to save upscaled images
* `DONE_DIR` : Directory to move original images after processing (set to `None` if you don't want to move them)

**Example:**

```python
# Input directory
INPUT_DIR = r"C:\StableDiffusion\sd-hiresfix-batch-upscaler\input"
# Output directory
OUTPUT_DIR = r"C:\StableDiffusion\sd-hiresfix-batch-upscaler\output"
# Directory to move original files after processing (if None, do not move)
DONE_DIR = r"C:\StableDiffusion\sd-hiresfix-batch-upscaler\done"
# DONE_DIR = None
```

You can use either absolute paths or relative paths.

```
# Absolute path
INPUT_DIR = r"C:\StableDiffusion\sd-hiresfix-batch-upscaler\input"
# Relative path
INPUT_DIR = r"./input"
```

### 4. Set Hires.fix upscaler settings

Edit these values in `hires_batch_upscaler.py` as needed:

- HR_UPSCALER : the upscaler to use in Hires.fix
- DENOISING_STRENGTH : the strength of denoising in Hires.fix
- HR_SCALE : the upscale factor
- HR_SECOND_PASS_STEPS : number of steps in Hires.fix (if `None`, the same as original sampling steps)

**Example:**

```python
# Upscaler
HR_UPSCALER = "ESRGAN_4x"
# Denoising strength
DENOISING_STRENGTH = 0.2
# Upscale factor
HR_SCALE = 2
# Hires steps (if None, same as original sampling steps)
HR_SECOND_PASS_STEPS = 20
```


### 5. Set URL settings

If you are running in a cloud environment or changed the port number, adjust the URL accordingly:

**Example:**

```python
BASE_URL = "http://127.0.0.1:7860"
```


### 6. Enable API in Stable Diffusion WebUI

Open your Stable Diffusion WebUI’s `webui-user.bat` in a text editor and add `--api` option to `COMMANDLINE_ARGS`.

**Example:**

```
set COMMANDLINE_ARGS=--xformers --api
```


## How to Use

1. Start Stable Diffusion WebUI AUTOMATIC1111 and generate your images.

2. Place the images you want to upscale into the folder specified by INPUT_DIR (the images must still contain the parameters generated by Stable Diffusion).

3. For Windows: run `run_hires_batch_upscaler.bat`.

   For Mac/Linux :

```
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python hires_batch_upscaler.py
```

Note: `python -m venv venv` and `pip install -r requirements.txt` are not required after the first run.

When finished, upscaled images will be saved to the folder specified by `OUTPUT_DIR`.
The original processed images will be moved to the `DONE_DIR` folder(if DONE_DIR is not None).


## License

MIT License
